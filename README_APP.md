# 構造力学解析アプリ

手書き構造図から自動で構造解析を行い、変形図と応力図を出力するStreamlitアプリケーションです。

## 機能

1. **画像認識**: YOLOv8-OBBモデルを使用して手書き構造図から要素を検出
2. **清書処理**: 検出した要素を15度刻みで整列し、テンプレートを使用して清書
3. **構造解析**: 剛性マトリクス法（FEM）による構造解析
4. **結果可視化**: 変形図、軸力図、せん断力図、曲げモーメント図の出力

## 対応要素

### 支点（4種類）
- ピン支点 (pin)
- ピンローラー支点 (roller)
- 固定支点 (fixed)
- ヒンジ (hinge)

### 荷重（4種類）
- 集中荷重 (load)
- 等分布荷重 (UDL)
- モーメント荷重（左回り） (momentL)
- モーメント荷重（右回り） (momentR)

### 部材
- 梁 (beam)

## 使用方法

### 1. 環境構築

```bash
# 仮想環境の作成（推奨）
python -m venv venv
venv\Scripts\activate  # Windows
# source venv/bin/activate  # Mac/Linux

# 必要なライブラリのインストール
pip install -r requirements.txt
```

### 2. アプリの起動

```bash
streamlit run structural_analysis_app.py
```

### 3. 操作手順

1. ブラウザが自動で開きます（開かない場合は http://localhost:8501 にアクセス）
2. サイドバーで解析パラメータを設定
   - 検出信頼度
   - 高さ揃え閾値
   - 接続閾値
   - 材料特性（ヤング係数、断面積、断面二次モーメント）
   - 荷重の大きさ
3. 手書き構造図の画像をアップロード
4. 「解析実行」ボタンをクリック
5. 結果を確認
   - 清書画像
   - 節点・部材情報
   - 変位・反力
   - 変形図
   - 応力図（N, Q, M）

## ファイル構成

```
.
├── structural_analysis_app.py  # メインアプリケーション
├── fem_lib.py                  # FEM解析ライブラリ
├── draw_lib.py                 # 描画処理ライブラリ
├── requirements.txt            # 必要なライブラリ
├── templates/                  # 要素テンプレート画像
│   ├── pin.png
│   ├── roller.png
│   ├── fixed.png
│   ├── hinge.png
│   ├── beam.png
│   ├── load.png
│   ├── UDL.png
│   ├── momentL.png
│   └── momentR.png
└── runs/obb/train31/weights/
    └── best.pt                 # YOLOv8-OBBモデル
```

## 技術仕様

### 画像認識
- モデル: YOLOv8-OBB (Oriented Bounding Box)
- 入力画像サイズ: 640x640
- 角度補正: 15度刻みで自動補正

### 構造解析
- 手法: 剛性マトリクス法（有限要素法）
- 要素: 平面骨組要素（6自由度/節点）
- 座標系: 2次元直交座標系

### 清書処理
- 支点のy座標を自動整列
- 梁端点と支点節点の自動接続（閾値内でスナップ）
- 荷重の作用点: 矢じりの先端
- 支点の節点位置: テンプレート画像の最上端中央

### 節点接続ロジック
1. 支点の節点座標を登録（テンプレート最上端）
2. 梁の端点を取得（四角形の最も離れた2点）
3. 各梁端点について最近傍の支点節点を探索
4. 閾値内（デフォルト25px）なら支点節点にスナップ
5. 閾値外なら新しい節点として登録

## 注意事項

- モデルファイルとテンプレート画像のパスは環境に応じて変更してください
- 手書き図面は明瞭に描いてください
- 複雑な構造の場合、検出精度が低下する可能性があります
- 等分布荷重(UDL)は現在の実装では部材全体に適用されます

## トラブルシューティング

### モデルが見つからない
```
エラー: モデルパスが存在しません
```
→ `MODEL_PATH` と `TEMPLATE_DIR` のパスを確認してください

### 解析エラー
```
エラー: FEM解析エラー
```
→ 構造が不安定（支点不足）または入力データに問題がある可能性があります

### 画像認識の精度が低い
- 画像の明るさ・コントラストを調整
- 検出信頼度の閾値を下げる
- より明瞭な手書き図面を使用

## ライセンス

このプロジェクトは教育目的で作成されています。

## 開発者

森本遥香 (DA22340)
